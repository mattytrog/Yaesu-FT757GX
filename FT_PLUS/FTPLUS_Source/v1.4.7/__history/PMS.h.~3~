#ifdef include_pms

#define refresh_rate_PMS 10


int8 program_mem_scan(INT32 curr_freq)
{
   
INT8 curr_mem_ch, res, limit;
   INT1 counterstart, stopped, dir; 
   INT16 counter2max;
   INT32 freq1, freq2, start_freq, end_freq;
   INT8 state;
   int8 dwell;
   state = get_state (1);
   IF (sw_500k) state += 4;
   INT8 vgrid = 15;
   #ifdef include_cb
   int8 save_region = cb_region;  
   #endif
   //gather frequencies based on rig state

   if ((state == 1) || (state == 2))
   {
         
      freq1 = band_bank[band];
      IF (band < 10)
      {
      freq2 = band_bank[band+1];
      }
      else 
      {
      freq2 = band_bank[0];
      }
      if(active_vfo == 0) vgrid = 1;
      if(active_vfo == 1) vgrid = 12;
      if(!curr_freq) curr_freq = freq1; 
      curr_mem_ch = 0;
      dwell = VFO_dwell_time;
   }
   if ((state == 5) || (state == 6))
      {
         freq1 = band_bank[band];
         freq2 = band_bank_edge[band];
         if(active_vfo == 0) vgrid = 1;
         if(active_vfo == 1) vgrid = 12;
         curr_freq = freq1;
         curr_mem_ch = 0;
         vgrid = state;
         dwell = VFO_dwell_time;
      }
   if (state == 3)
      {  
         curr_mem_ch = 0;
         freq1 = load_mem_ch_f (curr_mem_ch);
         if (curr_mem_ch >= 14) freq2 = load_mem_ch_f (0);
         else freq2 = load_mem_ch_f (curr_mem_ch + 1);
         curr_freq = freq1;
         vgrid = state;
         dwell = VFO_dwell_time;
      }
#ifdef include_cb
   if ((state == 4) || (state == 8))
      {
         limit = 40;
         curr_mem_ch = cb_channel;
         freq1 = load_cb(curr_mem_ch, cb_region);
         freq2 = max_freq;
         curr_freq = freq1;
         vgrid = 15;
         dwell = CB_dwell_time;
      }
#endif
   if (state == 7)
      {  
         limit = 14;
         curr_mem_ch = mem_channel;
         freq1 = load_mem_ch_f (curr_mem_ch);
         freq2 = max_freq;
         curr_freq = freq1;
         vgrid = state;
         dwell = MR_dwell_time;
      }
   
   
   if (freq1 == freq2){pms = 0; errorbeep (2); RETURN 0; }
   IF (freq1 < freq2){start_freq = freq1; end_freq = freq2;dir = 1; }
   IF (freq1 > freq2){start_freq = freq2; end_freq = freq1;dir = 0; }
   while(true)
   {
      if(sw_pms) { WHILE (sw_pms){} pms = 0; break;}
      if(squelch_open) stopped = 1;
      
      IF (counterstart) ++counter;
      ++counter1;
      
      

 
      
      if (((state >= 1) && (state <= 3)) || ((state >= 5) && (state <= 6)))
      {
         switch(flash)
         {
            case 1: VFD_data (vgrid, 0xFF, curr_freq, 0xFF, 0,0,0, refresh_rate_PMS) ; break;
            case 0:  VFD_data (0xFF, 0xFF, curr_freq, 0xFF, 0,0,0, refresh_rate_PMS) ; break;
         }
      }
 #ifdef include_cb     
      if((state == 4) || (state == 8))
      {
         curr_freq = load_cb(curr_mem_ch, cb_region);
         if(!cl)
         {
            switch(flash)
            {
               case 1: IF (flash) VFD_data (3, 0xFF, curr_mem_ch, 0xFF, 0,0, 6, refresh_rate_PMS); break;
               case 0: VFD_data (0xFF, 0xFF, curr_mem_ch, 0xFF, 0,0, 6, refresh_rate_PMS);  break; 
            }
         }
         else
         {
            switch(flash)
            {
               case 1: VFD_data (0xFF, dcs, curr_freq, 0xFF, 0,0,0, refresh_rate_PMS) ; break;
               case 0:  VFD_data (0xFF, 0xFF, curr_freq, 0xFF, 0,0,0, refresh_rate_PMS) ; break;
            }
         }
         
      }
#endif      
      if(state == 7)
      {
         curr_freq = load_mem_ch_f(curr_mem_ch);
         switch(flash)
         {
            case 1: VFD_data (3, 0xFF, curr_freq, curr_mem_ch, 0,0,0, refresh_rate_PMS) ; break;
            case 0: VFD_data (0xFF, 0xFF, curr_freq, curr_mem_ch, 0,0,0,refresh_rate_PMS) ; break;
         }
         
      }
      send_disp_buf(refresh_rate_PMS);
      update_PLL(curr_freq);
      
      
      if(!stopped)
      {

            if(counter1 > dwell)
            {
               if (((state >= 1) && (state <= 3)) || ((state >= 5) || (state <= 6)))
               {
               if(dir) curr_freq += 5; 
               else curr_freq -= 5;
               if(curr_freq < start_freq) curr_freq = end_freq;
               else if (curr_freq > end_freq) curr_freq = start_freq;
               }
               if((state == 4) || (state == 7) || (state == 8))
               {
                  if(curr_mem_ch < limit) ++curr_mem_ch; 
                  else
                  {
                     if(state == 7) curr_mem_ch = 0;
                     else 
                     #ifdef include_cb
                     if(state == 8)
                     {
                        if(cb_region < 7) ++cb_region; else cb_region = 0;
                        curr_mem_ch = 1;
                        curr_freq = load_cb(curr_mem_ch, cb_region);
                     }
                     else
                     #endif
                     curr_mem_ch = 1;
                  }
               }
               counter1 = 0;
            }
      }
      
      if(stopped)
      {
         IF (!squelch_open) counterstart = 1; else{counterstart = 0; counter = 0; }
         IF (counter > scan_pause_count) {counterstart = 0; stopped = 0; counter = 0; }
         res = buttons(1);
         IF ( (res == 3) || (res == 33)|| (res == 11))
         {
            if (((state >= 1) && (state <= 3)) || ((state >= 5) || (state <= 6))) curr_freq += 10;
            if((state == 4) || (state == 7) || (state == 8))
               {
                  if(curr_mem_ch < limit) ++curr_mem_ch; 
                  else
                  {
                     if(state == 7) curr_mem_ch = 0;
                     else curr_mem_ch = 1;
                  }
               }
      
            stopped = 0;
         }
         IF ( (res == 2)|| (res == 32) || (res == 12))
         {
            if (((state >= 1) && (state <= 3)) || ((state >= 5) || (state <= 6))) curr_freq -= 10;
            if((state == 4) || (state == 7) || (state == 8))
            {
               if(state == 7)
               {
                  if(curr_mem_ch > 0) --curr_mem_ch; else curr_mem_ch = limit;
               }
               else if(curr_mem_ch > 1) --curr_mem_ch; else curr_mem_ch = limit;
            }
            stopped = 0;
         }
         if(((state >= 1) && (state <= 3)) || ((state >= 5) || (state <= 6)))
         {
         if(curr_freq < start_freq) curr_freq = end_freq;
         else if (curr_freq > end_freq) curr_freq = start_freq;
         }
         if(sw_pms) { WHILE (sw_pms){} pms = 0;}
      }
      
      
      if(pms == 0) break;
   }
   if(squelch_open)
   {
      frequency = curr_freq;
   #ifdef include_cb
      if((state == 4) || (state == 8)) {cb_channel = curr_mem_ch; }
      
   #endif
      if(state == 7) {mem_channel = curr_mem_ch; }
      get_state(1);
   }
   else
   {
   #ifdef include_cb
      cb_region = save_region;
   #endif
      read_all_state();
   }
   return 1;
}
//!
#endif
